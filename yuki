#!/bin/bash

set -ex

function load {
  if [ ! -d Paper ]; then
    git clone -b ver/1.12.2 https://github.com/PaperMC/Paper.git Paper
  fi
  (
    cd Paper
    git reset --hard ver/1.12.2
    git clean -df
    if [ -d ../patches/custom ]; then
      find ../patches/custom -mindepth 1 -maxdepth 1 -type f -print0 | xargs -0 git am --3way
    fi
    ./paper patch
  )
}

function save {
  if [ ! -d Paper ]; then
    return
  fi
  (
    cd Paper
    find ../patches/custom -mindepth 1 -maxdepth 1 -type f -print0 | xargs -0 rm -f
    git format-patch -o ../patches/custom --no-stat --no-numbered --zero-commit ver/1.12.2
  )
  (
    cd Yukkit-API
    find ../patches/yukkit-api -mindepth 1 -maxdepth 1 -type f -print0 | xargs -0 rm -f
    git format-patch -o ../patches/yukkit-api --no-stat --no-numbered --zero-commit upstream/upstream
  )
  (
    cd Yukkit-Server
    find ../patches/yukkit-server -mindepth 1 -maxdepth 1 -type f -print0 | xargs -0 rm -f
    git format-patch -o ../patches/yukkit-server --no-stat --no-numbered --zero-commit upstream/upstream
  )
}

function jar {
  load
  mvn clean package
  (
    cd Paper/work/Paperclip
    mvn clean package -Dmcver=1.12.2 -Dpaperjar=../../../../Yukkit-Server/target/paper-1.12.2.jar -Dvanillajar=../../Minecraft/1.12.2/1.12.2.jar
  )
  cp -v Paper/work/Paperclip/assembly/target/paperclip-1.12.2.jar Yukkit.jar
}

"$@"
