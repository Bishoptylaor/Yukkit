#!/bin/bash

init() {
  git submodule update --init
}

setup() {
  init

  mkdir -p work
  rm -rf work/submods
  cp -rf modules work/submods

  pushd work

  working="$(pwd -P)"
  builddata="$working"/submods/BuildData
  ver=$(jq -r '.minecraftVersion' "$builddata"/info.json)

  if [ ! -f "$ver".jar ]; then
    curl -o "$ver".jar "$(jq -r '.serverUrl' "$builddata"/info.json)"
    [ "$(md5sum "$ver".jar | cut -d ' ' -f 1)" = "$(jq -r '.minecraftHash' "$builddata"/info.json)" ] || return
  fi

  if [ ! -f "$ver"-class.jar ]; then
    java -jar "$builddata"/bin/SpecialSource-2.jar map \
      -i "$ver".jar \
      -m "$builddata"/mappings/"$(jq -r '.classMappings' "$builddata"/info.json)" \
      -o "$ver"-class.jar
  fi

  if [ ! -f "$ver"-member.jar ]; then
    java -jar "$builddata"/bin/SpecialSource-2.jar map \
      -i "$ver"-class.jar \
      -m "$builddata"/mappings/"$(jq -r '.memberMappings' "$builddata"/info.json)" \
      -o "$ver"-member.jar
  fi

  if [ ! -f "$ver"-mapped.jar ]; then
    java -jar "$builddata"/bin/SpecialSource.jar \
      --kill-lvt \
      -i "$ver"-member.jar \
      --access-transformer "$builddata"/mappings/"$(jq -r '.accessTransforms' "$builddata"/info.json)" \
      -m "$builddata"/mappings/"$(jq -r '.packageMappings' "$builddata"/info.json)" \
      -o "$ver"-mapped.jar
  fi

  (
    cd submods/CraftBukkit
    mvn install:install-file \
      -Dfile="$working"/"$ver"-mapped.jar \
      -Dpackaging=jar \
      -DgroupId=org.spigotmc \
      -DartifactId=minecraft-server \
      -Dversion="$ver"-SNAPSHOT
  )

  popd
}

clean() {
  if [ -f .gitmodules ]; then
    git submodule deinit --force --all
  fi

  rm -rf .git/modules

  rm -f .gitmodules
  rm -rf modules

  git rm --ignore-unmatch .gitmodules
  git rm -r --ignore-unmatch modules
}

reinit() {
  clean

  touch .gitmodules
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/bukkit.git modules/Bukkit
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/craftbukkit.git modules/CraftBukkit
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/builddata.git modules/BuildData
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/spigot.git modules/Spigot
  git submodule add https://github.com/PaperMC/Paperclip.git modules/Paperclip
  git submodule add https://github.com/PaperMC/Paper.git modules/Paper
  git submodule update --init --force

  ( cd modules/Bukkit && git checkout 558fdf5f54b0f527cd48903daf9368ac4b862876 && git clean -d --force )
  ( cd modules/CraftBukkit && git checkout acbc348e925cbdbae41b2055d60bbe40031d470c && git clean -d --force )
  ( cd modules/BuildData && git checkout be360cc298a06b5355ecd057f5b1feb894a73f0f && git clean -d --force )
  ( cd modules/Spigot && git checkout 79a30d7d26b9078dbf6071cbbfa060673bf117b2 && git clean -d --force )
  ( cd modules/Paper && git checkout 77cce8236ff09d52730b66c7a146265ce3415185 && git clean -d --force )
  git add modules

  git submodule status
}

if [ -z "$@" ] || [ "$1" = 'help' ]; then
  echo "$0 [ init | setup | clean | reinit ]"
  exit 1
fi

set -ex

"$@"
