#!/bin/bash

init() {
  git submodule update --init
}

setup() {
  init

  mkdir -p work
  rm -rf work/submods
  cp -rf modules work/submods

  pushd work

  bd="$PWD"/submods/BuildData
  ver=$(jq -r '.minecraftVersion' "$bd"/info.json)

  if [ ! "$ver".jar ]; then
    curl -o "$ver".jar "$(jq -r '.serverUrl' "$bd"/info.json)"
    [ "$(md5sum "$ver".jar | cut -d ' ' -f 1)" = "$(jq -r '.minecraftHash' "$bd"/info.json)" ] || return
  fi
  [ -f "$ver"-class.jar ] || java -jar "$bd"/bin/SpecialSource-2.jar map -i "$ver".jar -m "$bd"/mappings/"$(jq -r '.classMappings' "$bd"/info.json)" -o "$ver"-class.jar
  [ -f "$ver"-member.jar ] || java -jar "$bd"/bin/SpecialSource-2.jar map -i "$ver"-class.jar -m "$bd"/mappings/"$(jq -r '.memberMappings' "$bd"/info.json)" -o "$ver"-member.jar
  [ -f "$ver"-mapped.jar ] || java -jar "$bd"/bin/SpecialSource.jar --kill-lvt -i "$ver"-member.jar --access-transformer "$bd"/mappings/"$(jq -r '.accessTransforms' "$bd"/info.json)" -m "$bd"/mappings/"$(jq -r '.packageMappings' "$bd"/info.json)" -o "$ver"-mapped.jar
  mvn -f submods/CraftBukkit/pom.xml install:install-file -Dfile="$PWD"/"$ver"-mapped.jar -Dpackaging=jar -DgroupId=org.spigotmc -DartifactId=minecraft-server -Dversion="$ver"-SNAPSHOT

  popd
}

clean() {
  if [ -f .gitmodules ]; then
    git submodule deinit --force --all
  fi

  rm -rf .git/modules

  rm -f .gitmodules
  rm -rf modules

  git rm --ignore-unmatch .gitmodules
  git rm -r --ignore-unmatch modules
}

reinit() {
  clean

  touch .gitmodules
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/bukkit.git modules/Bukkit
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/craftbukkit.git modules/CraftBukkit
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/builddata.git modules/BuildData
  git submodule add https://hub.spigotmc.org/stash/scm/spigot/spigot.git modules/Spigot
  git submodule add https://github.com/PaperMC/Paperclip.git modules/Paperclip
  git submodule add https://github.com/PaperMC/Paper.git modules/Paper
  git submodule update --init --force

  ( cd modules/Bukkit && git checkout 558fdf5f54b0f527cd48903daf9368ac4b862876 && git clean -d --force )
  ( cd modules/CraftBukkit && git checkout acbc348e925cbdbae41b2055d60bbe40031d470c && git clean -d --force )
  ( cd modules/BuildData && git checkout be360cc298a06b5355ecd057f5b1feb894a73f0f && git clean -d --force )
  ( cd modules/Spigot && git checkout 79a30d7d26b9078dbf6071cbbfa060673bf117b2 && git clean -d --force )
  ( cd modules/Paper && git checkout 77cce8236ff09d52730b66c7a146265ce3415185 && git clean -d --force )
  git add modules

  git submodule status
}

if [ -z "$@" ] || [ "$1" = 'help' ]; then
  echo "$0 [ init | setup | clean | reinit ]"
  exit 1
fi

set -ex

"$@"
